# JSON Sync Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                        APP STARTUP                               │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ ContentView      │
                    │ .task { }        │
                    └──────────────────┘
                              │
                              ▼
                ┌──────────────────────────────┐
                │ loadInitialDataIfNeeded()    │
                └──────────────────────────────┘
                              │
                              ▼
            ┌─────────────────────────────────────┐
            │ Create MeritBadgeJSONSyncService    │
            └─────────────────────────────────────┘
                              │
                              ▼
            ┌─────────────────────────────────────┐
            │ checkAndSyncIfNeeded()              │
            └─────────────────────────────────────┘
                              │
                              ▼
            ┌─────────────────────────────────────┐
            │ Calculate SHA256 hash of JSON       │
            │ merit_badges_lite.json              │
            └─────────────────────────────────────┘
                              │
                              ▼
            ┌─────────────────────────────────────┐
            │ Compare with UserDefaults hash      │
            └─────────────────────────────────────┘
                              │
                    ┌─────────┴─────────┐
                    │                   │
                    ▼                   ▼
            ┌──────────────┐    ┌──────────────┐
            │ HASHES MATCH │    │ HASHES DIFFER│
            └──────────────┘    └──────────────┘
                    │                   │
                    ▼                   ▼
            ┌──────────────┐    ┌──────────────────────────┐
            │ Skip Sync    │    │ Perform Sync             │
            │ (Fast path)  │    │ syncJSONToDatabase()     │
            └──────────────┘    └──────────────────────────┘
                    │                   │
                    │                   ▼
                    │           ┌────────────────────────────┐
                    │           │ Load badges from JSON      │
                    │           └────────────────────────────┘
                    │                   │
                    │                   ▼
                    │           ┌────────────────────────────┐
                    │           │ Fetch existing from DB     │
                    │           └────────────────────────────┘
                    │                   │
                    │                   ▼
                    │           ┌────────────────────────────┐
                    │           │ Create lookup dictionary   │
                    │           │ by badge name              │
                    │           └────────────────────────────┘
                    │                   │
                    │                   ▼
                    │           ┌────────────────────────────┐
                    │           │ For each JSON badge:       │
                    │           └────────────────────────────┘
                    │                   │
                    │          ┌────────┴────────┐
                    │          ▼                 ▼
                    │    ┌──────────┐      ┌─────────┐
                    │    │ EXISTS?  │      │ NEW?    │
                    │    └──────────┘      └─────────┘
                    │          │                 │
                    │          ▼                 ▼
                    │    ┌─────────────┐   ┌─────────────┐
                    │    │ UPDATE      │   │ INSERT      │
                    │    │ Preserve    │   │ New badge   │
                    │    │ user        │   │ to DB       │
                    │    │ progress    │   │             │
                    │    └─────────────┘   └─────────────┘
                    │          │                 │
                    │          └────────┬────────┘
                    │                   ▼
                    │           ┌────────────────────────────┐
                    │           │ Check for removed badges   │
                    │           │ (in DB but not in JSON)    │
                    │           └────────────────────────────┘
                    │                   │
                    │                   ▼
                    │           ┌────────────────────────────┐
                    │           │ Keep them (default)        │
                    │           │ Or delete (optional)       │
                    │           └────────────────────────────┘
                    │                   │
                    │                   ▼
                    │           ┌────────────────────────────┐
                    │           │ Save to database           │
                    │           └────────────────────────────┘
                    │                   │
                    │                   ▼
                    │           ┌────────────────────────────┐
                    │           │ Update UserDefaults hash   │
                    │           │ Update sync date           │
                    │           └────────────────────────────┘
                    │                   │
                    └───────────────────┘
                              │
                              ▼
                    ┌──────────────────┐
                    │ APP READY        │
                    │ Badges loaded    │
                    │ Progress intact  │
                    └──────────────────┘


═══════════════════════════════════════════════════════════════════

PROGRESS PRESERVATION EXAMPLE
═══════════════════════════════════════════════════════════════════

BEFORE UPDATE:
┌────────────────────────────────────────┐
│ Badge: "First Aid"                     │
│ Requirements:                          │
│   1. ☑ Explain consent                 │
│   2. ☑ Assess scene                    │
│   3. ☐ Three hurry cases               │
│ Progress: 66%                          │
│ Date Started: Nov 1, 2025              │
└────────────────────────────────────────┘

JSON UPDATED:
┌────────────────────────────────────────┐
│ {                                      │
│   "name": "First Aid",                 │
│   "requirements": [                    │
│     "Explain consent",           ← Same│
│     "Assess scene",              ← Same│
│     "Three hurry cases",         ← Same│
│     "Handle bleeding"            ← NEW │
│   ]                                    │
│ }                                      │
└────────────────────────────────────────┘

AFTER SYNC:
┌────────────────────────────────────────┐
│ Badge: "First Aid"                     │
│ Requirements:                          │
│   1. ☑ Explain consent         (kept!) │
│   2. ☑ Assess scene            (kept!) │
│   3. ☐ Three hurry cases       (kept!) │
│   4. ☐ Handle bleeding         (new!)  │
│ Progress: 50%                          │
│ Date Started: Nov 1, 2025      (kept!) │
└────────────────────────────────────────┘

═══════════════════════════════════════════════════════════════════

MANUAL SYNC FLOW
═══════════════════════════════════════════════════════════════════

        User Action
             │
             ▼
    ┌────────────────┐
    │ Tap ⓘ button   │
    └────────────────┘
             │
             ▼
    ┌────────────────────┐
    │ Select "Sync with  │
    │ JSON File"         │
    └────────────────────┘
             │
             ▼
    ┌────────────────────┐
    │ syncWithJSON()     │
    └────────────────────┘
             │
             ▼
    ┌────────────────────┐
    │ forceResync()      │
    │ (ignores hash)     │
    └────────────────────┘
             │
             ▼
    ┌────────────────────┐
    │ Perform full sync  │
    │ (same as startup)  │
    └────────────────────┘
             │
             ▼
    ┌────────────────────┐
    │ Done! UI updates   │
    └────────────────────┘

═══════════════════════════════════════════════════════════════════

HASH COMPARISON LOGIC
═══════════════════════════════════════════════════════════════════

Current Hash:    abc123def456...
                      │
                      ▼
          ┌───────────────────────┐
          │ UserDefaults lookup   │
          │ key: lastJSONSyncHash │
          └───────────────────────┘
                      │
                      ▼
Last Known Hash: abc123def456...
                      │
             ┌────────┴────────┐
             │                 │
         MATCH?              MATCH?
          YES                 NO
             │                 │
             ▼                 ▼
      ┌──────────┐      ┌─────────────┐
      │ Skip     │      │ Full Sync   │
      │ (~5ms)   │      │ (~100ms)    │
      └──────────┘      └─────────────┘

═══════════════════════════════════════════════════════════════════

DATA STORAGE OVERVIEW
═══════════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────────┐
│                          APP BUNDLE                              │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ merit_badges_lite.json                                     │ │
│  │ • Source of truth                                          │ │
│  │ • Read-only at runtime                                     │ │
│  │ • Edited in Xcode before build                             │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                    Read & Hash on startup
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        USER DEFAULTS                             │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ lastJSONSyncHash: "abc123..."                              │ │
│  │ lastSyncDate: "2025-11-11 15:45:00"                        │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
                              │
                    Compare & Sync if needed
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      SWIFT DATA DATABASE                         │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ MeritBadge Models                                          │ │
│  │ • Badge definitions                                        │ │
│  │ • User progress (dates, completions)                       │ │
│  │ • Requirement status                                       │ │
│  │ • Persistent across app launches                           │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```
